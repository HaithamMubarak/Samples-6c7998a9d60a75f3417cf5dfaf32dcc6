 /****************************************************************************
  **
  ** Copyright (C) 2014 , By Haitham Mubarak
  ** You may use this file under the terms of the BSD license as follows:
  **
  ** "Redistribution and use in source and binary forms, with or without
  ** modification, are permitted provided that the following conditions are
  ** met:
  **   * Redistributions of source code must retain the above copyright
  **     notice, this list of conditions and the following disclaimer.
  **   * Redistributions in binary form must reproduce the above copyright
  **     notice, this list of conditions and the following disclaimer in
  **     the documentation and/or other materials provided with the
  **     distribution.
  **   * Neither the name of Digia Plc and its Subsidiary(-ies) nor the names
  **     of its contributors may be used to endorse or promote products derived
  **     from this software without specific prior written permission.
  **
  **
  ** THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
  ** "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
  ** LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
  ** A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
  ** OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
  ** SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
  ** LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
  ** DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
  ** THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
  ** (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
  ** OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE."
  **
  ** $QT_END_LICENSE$
  **
  ****************************************************************************/
 var RadarComponent=function(t){var e=this;e.data=t,e.data.el.innerHTML="";var a=document.createElement("div");a.setAttribute("style","width : 100%;height : 100%;position: relative;"),e.data.el.appendChild(a);var n=function(){clearInterval(e.blink_timer),e.data.enable_blink&&(e.blink_timer=setInterval(function(){if(e.hide_blinking_points=!e.hide_blinking_points,!e.animationRotateMode&&!e.animationMoveMode){var t=e.defaultDrawConfig||{};t.callSrc=n,t.layers={layers:{shape:!1,points:!0}},e.draw(t)}},e.data.blink_period||1e3))},i=function(a,n,i){var o=t.northAngle*(Math.PI/180);if(i&&i.disableRotation)var r=a.x,l=a.y;else var r=Math.cos(o)*a.x-Math.sin(o)*a.y,l=Math.sin(o)*a.x+Math.cos(o)*a.y;if(i&&i.disablePixelProjection)s={x:r,y:l,blink:a.blink,label:a.label,constant:a.constant};else var s={x:n.x+r/e.data.circleRadiusStep*e.data.stepFactor,y:n.y-l/e.data.circleRadiusStep*e.data.stepFactor,blink:a.blink,label:a.label,constant:a.constant};return s},o=function(t,e){return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))},r={},l=function(t,e){var a=document.createElement("canvas");a.setAttribute("id","radar-layer-"+t),a.setAttribute("style","position:absolute;width : 100%;height : 100%;z-index:"+e),r[t.toString()]=a};l("shape",0),l("points",1);for(var s in r)a.appendChild(r[s]);var d=function(t){var e="rotate("+t+"deg)";a.style.transform=e,a.style["-ms-transform"]=e,a.style["-moz-transform"]=e,a.style["-webkit-transform"]=e},c=function(t,e,a,n,i){var o=r.shape.getContext("2d");o.beginPath(),o.arc(t.x,t.y,e,0,2*Math.PI,!1),o.fillStyle="blue",o.fill(),o.lineWidth=2,o.strokeStyle="white",o.stroke(),o.font="18pt Calibri",o.textAlign="center",o.fillStyle="white",o.fillText(a,t.x+n,t.y+i)},h=function(t,e){var a=r.shape.getContext("2d");a.beginPath(),a.fillStyle=e,a.moveTo(centerPoint.x+t[0].x,centerPoint.y-t[0].y),a.lineTo(centerPoint.x+t[1].x,centerPoint.y-t[1].y),a.lineTo(centerPoint.x+t[2].x,centerPoint.y-t[2].y),a.fill()},v=function(t,e){(t=r.shape.getContext("2d")).beginPath(),t.moveTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[1].y),t.stroke()};e.draw=function(a){var o=a&&a.callSrc;console.log("_self.draw()"),e.blink_timer&&o!=n&&(clearInterval(e.blink_timer),e.blink_timer=void 0,e.hide_blinking_points=!1);var l=a&&a.layers||{},s=a&&a.points||{mode:"both"};for(var f in r)void 0===l[f]&&(l[f]=!0);for(var f in r)l[f]&&((y=r[f]).width=e.data.el.offsetWidth,y.height=e.data.el.offsetHeight);var g=e.data.northAngle;e.data.northAngle=0,d(0);for(var f in r){var y=r[f];l[f]&&(console.log('clear("'+f+'")'),y.getContext("2d").clearRect(0,0,y.width,y.height))}var m=r.shape.width-34,p=r.shape.height-66,b=Math.min(m,p),x=r.shape.width/2,P=r.shape.height/2,u=b/2;if(centerPoint={x:x,y:P},e.centerPoint=centerPoint,l.shape){console.log('updateLayer("shape")');var k=(I=r.shape.getContext("2d")).createRadialGradient(centerPoint.x,centerPoint.y,1,centerPoint.x,centerPoint.y,u);k.addColorStop(0,"rgb(1, 63, 0)"),k.addColorStop(1,"rgb(0, 112, 0)");var _=e.data.circleRadiusStep/e.data.stepFactor;I.beginPath(),I.arc(x,P,u,0,2*Math.PI,!1),I.fillStyle=k,I.fill(),I.lineWidth=1,I.strokeStyle="rgb(28,227,59)",I.stroke();var M=u*_,S=[i({x:0,y:M},centerPoint),i({x:0,y:-M},centerPoint)],w=[i({x:M,y:0},centerPoint),i({x:-M,y:0},centerPoint)];v(I,S),v(I,w);t.circleRadiusStep;var C=t.stepFactor;e.data.maxdistance;C<=0&&(C=1);for(j=0;;j++){var A=(j+1)*C;if(A>u)break;I.beginPath(),I.arc(x,P,A,0,2*Math.PI,!1),I.lineWidth=1,I.stroke()}c(w[0],15,"E",0,9),c(w[1],15,"W",0,9),c(S[0],15,"N",0,9),c(S[1],15,"S",0,9);var R=[i({x:7.5,y:u+15+2},centerPoint,{disablePixelProjection:!0}),i({x:-7.5,y:u+15+2},centerPoint,{disablePixelProjection:!0}),i({x:0,y:u+15+2+15},centerPoint,{disablePixelProjection:!0})];h(R,"blue")}if(l.points){console.log('updateLayer("points")');for(var I=r.points.getContext("2d"),T=e.data.points,W=[],j=0;j<T.length;j++)W.push(i(T[j],centerPoint));e.projectedPoints=W;var F=s.mode;if(I.strokeStyle="white","coordinates"!=F){I.lineWidth=1;for(j=1;j<W.length;j++){var E=W[j],L=W[j-1];I.beginPath(),I.moveTo(L.x,L.y),I.lineTo(E.x,E.y),I.stroke()}}for(var D=t.pointRadius,j=0;j<W.length;j++)(E=W[j]).blink&&t.enable_blink&&e.hide_blinking_points||("path"!=F||E.constant||j==W.length-1)&&(I.beginPath(),I.arc(E.x,E.y,D,0,2*Math.PI,!1),T[j].blink?I.fillStyle="red":I.fillStyle="blue",I.fill(),I.lineWidth=1,I.stroke())}e.data.northAngle=g,d(e.data.northAngle),n(),e.defaultDrawConfig=a},a.addEventListener("click",function(t){var a={x:t.offsetX,y:t.offsetY};o(e.centerPoint,a)<=5&&console.log("you clicked on the center");for(var n=e.projectedPoints,i=0;i<n.length;i++)o(n[i],a)<=5&&n[i].label&&console.log('you clicked on "'+n[i].label+'"')},!1),e.rotate=function(t){if(!e.animationRotateMode){e.animationRotateMode=!0;var a,n=(t=(t+360)%360)-e.data.northAngle,i=-(360-t)-e.data.northAngle;a=Math.abs(n)>Math.abs(i)?i:n;var o=e.data.animateFrames||10,r=o;e.animate_rotate_timer=setInterval(function(){e.data.northAngle=(e.data.northAngle+a/o)%360,d(e.data.northAngle),--r<=0&&(clearInterval(e.animate_rotate_timer),self.animate_rotate_timer=void 0,e.animationRotateMode=!1)},e.data.animate_period||100)}},e.move=function(){var a;if(0!=arguments.length)if(1==arguments.length?a=arguments[0]:arguments.length>=2&&(a={x:arguments[0],y:arguments[1]}),e.moving=e.moving||!1,e.moving)setTimeout(function(){e.move(a)},250);else if(!e.animationMode){e.moving=!0,e.animationMoveMode=!0;var i=e.data.animateFrames||10,o=i,r=a.x/i,l=a.y/i;e.animate_move_timer=setInterval(function(){for(var a=0;a<t.points.length;a++){var i=t.points[a];i.constant||(i.y-=l,i.x-=r)}var s=e.defaultDrawConfig||{};s.callSrc=n,s.layers={layers:{shape:!1,points:!0}},e.draw(s),--o<=0&&(clearInterval(e.animate_move_timer),self.animate_move_timer=void 0,e.animationMoveMode=!1,e.moving=!1)},e.data.animate_period||100)}}};